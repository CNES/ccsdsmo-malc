<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>Actor - MAL C API</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="..">MAL C API</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="..">Home</a>
                    </li>
                
                
                
                    <li >
                        <a href="../tutorial/">Tutorial</a>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">MAL APIs <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../mal_attributes/">Attributes</a>
</li>

                        
                            
<li >
    <a href="../mal_encoding/">Encoding</a>
</li>

                        
                            
<li >
    <a href="../mal_api/">MAL</a>
</li>

                        
                            
<li >
    <a href="../mal_transport/">Transport</a>
</li>

                        
                            
<li >
    <a href="../area/">Area</a>
</li>

                        
                            
<li class="active">
    <a href="./">Actor</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Transports <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../mal_czmq/">MAL/ZMQ</a>
</li>

                        
                            
<li >
    <a href="../mal_tcp/">MAL/TCP</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Generators <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../stub_generator/">Stubs generator</a>
</li>

                        
                            
<li >
    <a href="../malbinary_generator/">MalBinary</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../annexes/">Annexs</a>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../area/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../mal_czmq/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#actor-handler-execution-model">Actor / Handler Execution Model</a></li>
        
            <li><a href="#mal-actor">MAL Actor</a></li>
        
            <li><a href="#mal-actor-api">MAL Actor API</a></li>
        
            <li><a href="#simple-example-of-a-mal-application">Simple example of a MAL application</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="actor-handler-execution-model">Actor / Handler Execution Model</h1>
<p>The MAL actor uses the MAL C API and in particular the notions of <strong>poller</strong>, <strong>end-point</strong> and <strong>handler</strong>. It is based on the notion of CZMQ actor.</p>
<h2 id="mal-actor">MAL Actor</h2>
<p>An actor is in charge of the execution of a set of interaction handlers corresponding to the interactions of a given end-point. The API allows the dynamic addition and removal of handlers. To avoid problems related to parallelism, registering and deleting a handler can be made only from the actor himself.
A handler can only be performed by an unique actor.</p>
<p>An actor reacts to MAL messages independently of any role in the interaction. When receiving a message it searches for the corresponding handler in the list of registered handlers. If successful, it activates the handler by calling the function corresponding to the received message, otherwise the message is destroyed.</p>
<p>The lifetime of an interaction exceeds the reaction of the actor.</p>
<p>Only the actor who received the message initiating an interaction can answer to this interaction.</p>
<p>An actor has the following features:
-   It corresponds to a single a single endpoint, therefore:
    - It can only use a single transport (binding) to receive and send MAL messages.
    - It can use multiple encoding formats for the MAL message body.
    - It is uniquely identified by a MAL URI relative to the MAL context, the format of this URI depends on the transport used.
    - It handles a counter of <code>Transaction Id</code> (field of MAL header)
-   It owns a state.
-   Its life cycle has three states:
      - When created the <code>initialize</code> function is called before the launch of processing loop that handles incoming message.
      - When receiving a message the processing loop calls the <code>handle</code> function to search the handler corresponding to the received message and then activate it.
      - When stopped the <code>finalize</code> function is called before the actor destruction.
-   The <code>initialize</code> and <code>finalize</code> functions are customizable by the user.
-   It runs in single-threaded way.
-   Its state can be changed only through the handlers reactions.
-   Its state can not be transmitted to another actor.</p>
<p>If a multithreaded execution mode is needed, for example to perform a costly CPU processing, then the handler must delegate the execution of this task to different actors. The processing is then performed in parallel, and the associated load is shared between all these actors.</p>
<p>Each actor defines a specific endpoint corresponding to the listen socket of the underlying C/ZMQ actor, it uses the concept of poller to simultaneously listen to the user end-point and this internal end-point. The internal end-point allows to receive commands sent to the actor by the <code>mal_actor_send_command</code> function.</p>
<h2 id="mal-actor-api">MAL Actor API</h2>
<h3 id="constructor">Constructor</h3>
<p>Create an actor instance identified by a MAL URI. Creating an actor will create the end-point corresponding to the MAL URI of this actor, and the router needed to manage handlers of this actor. The state of this router is the state of the actor.</p>
<p>A <code>Transaction Id</code> counter is created.</p>
<p>Declaration:</p>
<pre><code class="c">mal_actor_t *mal_actor_new(
  mal_ctx_t *mal_ctx,
  mal_uri_t *uri,
  void *state,
  mal_actor_initialize_fn *initialize,
  mal_actor_finalize_fn *finalize);
</code></pre>

<p>Parameters:</p>
<ul>
<li><code>mal_ctx</code> : MAL context</li>
<li><code>uri</code> : MAL URI that identify this actor</li>
<li><code>state</code> : actor state; untyped to allow polymorphism</li>
<li><code>initialize</code> : initialization function</li>
<li><code>finalize</code> : finalization function</li>
</ul>
<h3 id="virtual-initialization-function-of-the-mal-actor">Virtual initialization function of the MAL actor</h3>
<p>Declaration:</p>
<pre><code class="c">typedef int mal_actor_initialize_fn(void *self, mal_ctx_t *mal_ctx, mal_actor_t *mal_actor);
</code></pre>

<p>Parameters:</p>
<ul>
<li><code>self</code> : actor state</li>
<li><code>mal_ctx</code> : MAL context pointer</li>
<li><code>mal_actor</code> : MAL actor pointer</li>
</ul>
<p>Result:</p>
<ul>
<li>Error code</li>
</ul>
<h3 id="virtual-finalisation-function-of-the-mal-actor">Virtual finalisation function of the MAL actor</h3>
<p>Declaration:</p>
<pre><code class="c">typedef int mal_handler_finalize_fn(void *self, mal_ctx_t *mal_ctx, mal_actor_t *mal_actor);
</code></pre>

<p>Parameters:</p>
<ul>
<li><code>self</code> : actor state</li>
<li><code>mal_ctx</code> : MAL context pointer</li>
<li><code>mal_actor</code> : MAL actor pointer</li>
</ul>
<p>Result:</p>
<ul>
<li>Error code</li>
</ul>
<h3 id="sending-a-mal-message">Sending a MAL message</h3>
<p>MAL messages are sent through the actor's integrated endpoint (see interface defined in 7.4.2). The actor's interface defines a function to find the corresponding end-point:</p>
<pre><code class="c">mal_endpoint_t *mal_actor_get_mal_endpoint(mal_actor_t *self);
</code></pre>

<h3 id="handlers-registration">Handlers registration</h3>
<p>The registration of the handlers is done through the actor's integrated router (see interface defined in 7.6.3).
The actor's interface defines a function to find the corresponding router:</p>
<pre><code class="c">mal_routing_t *mal_actor_get_router(mal_actor_t *self);
</code></pre>

<h3 id="sending-a-command-to-the-mal-actor">Sending a command to the MAL actor</h3>
<p>Sending commands to the an actor via its internal endpoint can be done through the following function:</p>
<pre><code class="c">int mal_actor_send_command(mal_actor_t *to, char *cmd);
</code></pre>

<p>The parameters of this function are the recipient actor and the string containing the command.
For example, to request the termination of an actor:</p>
<pre><code class="c">mal_actor_send_command(actor, &quot;$TERM&quot;);
</code></pre>

<h3 id="destructor">Destructor</h3>
<p>Deletes the actor and free its state.</p>
<pre><code class="c">void mal_actor_destroy(mal_actor_t **self_p);
</code></pre>

<h2 id="simple-example-of-a-mal-application">Simple example of a MAL application</h2>
<p>In this example we use the code already introduced in the tutorial but we use the library of actors described in this chapter.
Most of the code is identical and we only detail the aspects specifically related to the use of MAL actors framework.</p>
<h3 id="consumer-component">Consumer component</h3>
<p>During the creation of the consumer component we also create a MAL actor for managing this component:</p>
<pre><code class="c">send_app_myconsumer_t *consumer = send_app_myconsumer_new(
  provider_uri,
  authentication_id, qoslevel, priority, domain, network_zone, session,
  session_name, MALBINARY_FORMAT_CODE, encoder, decoder);
</code></pre>

<pre><code class="c">mal_uri_t *consumer_uri = mal_ctx_create_uri(mal_ctx, &quot;send_app/myconsumer&quot;);
mal_actor_t *consumer_actor = mal_actor_new(
  mal_ctx,
  consumer_uri, consumer,
  send_app_myconsumer_initialize, send_app_myconsumer_finalize);
</code></pre>

<p>The initialization and termination functions are provided to the actor during its creation.
The initialization function allows us to initiate the SEND interaction to the provider. This code corresponds
to the code the run method described in section 4.1.2.</p>
<h3 id="provider-component">Provider component</h3>
<p>During the creation of the provider component we also create a MAL actor for managing this component:</p>
<pre><code class="c">send_app_myprovider_t *provider =
  send_app_myprovider_new(MALBINARY_FORMAT_CODE, encoder, decoder);
</code></pre>

<pre><code class="c">mal_actor_t *provider_actor = mal_actor_new(
  mal_ctx,
  provider_uri, provider,
  send_app_myprovider_initialize, send_app_myprovider_finalize);
</code></pre>

<p>The initialization and termination functions are provided to the actor during its creation.
The initialization function allow to record the handlers of the provider.
The message reception is now handled automatically by the MAL actor:</p>
<ul>
<li>When a MAL message is received on the endpoint corresponding to the provider's URI the registered handler is automatically executed.</li>
<li>Otherwise the message is destroyed.</li>
</ul>
<h3 id="run-the-application">Run the application</h3>
<p>Consumer and provider components are now actors, they do not require explicit creation of a ZMQ an actor to run:</p>
<pre><code class="c">send_app_create_provider(verbose, mal_ctx, provider_uri, encoder, decoder);
send_app_create_consumer(verbose, mal_ctx, provider_uri, encoder, decoder);
</code></pre>

<p>The launch of the application code is identical:</p>
<ul>
<li>creation of the MAL context,</li>
<li>creation of encoder and decoder components,</li>
<li>instantiation of the MALZMQ transport,</li>
<li>starting the MAL context.</li>
</ul></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script>var base_url = '..';</script>
        <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
        <script src="../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
