<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>Actor - MAL C API</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="..">MAL C API</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="..">Accueil</a>
                    </li>
                
                
                
                    <li >
                        <a href="../tutorial/">Tutoriel</a>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">APIs MAL <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../mal_attributes/">Attributs</a>
</li>

                        
                            
<li >
    <a href="../mal_encoding/">Encodage</a>
</li>

                        
                            
<li >
    <a href="../mal_api/">MAL</a>
</li>

                        
                            
<li >
    <a href="../mal_transport/">Transport</a>
</li>

                        
                            
<li >
    <a href="../area/">Area</a>
</li>

                        
                            
<li class="active">
    <a href="./">Actor</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Transports <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../mal_czmq/">MAL/CZMQ</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Générateurs <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../stub_generator/">Stubs de service</a>
</li>

                        
                            
<li >
    <a href="../malbinary_generator/">MalBinary</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li >
                        <a href="../annexes/">Annexes</a>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../area/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../mal_czmq/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#modele-dexecution-acteur-handler">Modèle d'exécution Acteur / Handler</a></li>
        
            <li><a href="#acteur">Acteur</a></li>
        
            <li><a href="#api-actor-mal">API Actor MAL</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="modele-dexecution-acteur-handler">Modèle d'exécution Acteur / Handler</h1>
<p>L'acteur MAL utilise l'API MAL/C et en particulier les notions de <strong>poller</strong>, de <strong>end-point</strong> et de <strong>handler</strong>. Il repose sur la notion d'acteur CZMQ.</p>
<h2 id="acteur">Acteur</h2>
<p>Un acteur est en charge de l'exécution d'un ensemble de handlers d'interactions correspondant aux interactions d'un end-point donné. L'API permet l'ajout et la suppression dynamique de handlers. Afin d'éviter les problèmes liés au parallélisme, l'enregistrement et la suppression d'un handler ne peut s'effectuer que depuis l'acteur lui-même.
Un Handler ne peut être exécuté que par un unique acteur.</p>
<p>Un acteur réagit aux messages MAL indépendamment de tout rôle dans l'interaction. Lors de la réception d'un message il recherche le handler correspondant dans la liste des handlers  enregistrés. En cas de succès il active cet handler en appelant la fonction correspondant au message reçu, dans le cas contraire le message est détruit.</p>
<p>La durée de vie d'une interaction dépasse celle d'une réaction de l'acteur.</p>
<p>Seul l'acteur qui a reçu le message initiant une interaction peut répondre à cette interaction.</p>
<p>Un acteur possède les caractéristiques suivantes :</p>
<ul>
<li>Il correspond à un unique end-point, en conséquence :<ul>
<li>Il ne peut utiliser qu'un unique transport (binding) pour recevoir et envoyer des messages MAL.</li>
<li>Il peut utiliser plusieurs formats d'encodage du corps de message MAL.</li>
<li>Il est identifié de manière unique par une URI MAL relative au contexte MAL et dont le format dépend du transport utilisé.</li>
<li>Il gère un compteur de 'Transaction Id' (champ du header MAL)</li>
</ul>
</li>
<li>Il possède un état.</li>
<li>Il a un cycle de vie à 3 trois états :<ul>
<li>Lors de sa création la fonction <code>initialize</code> est appelée avant de le lancement de la boucle de traitement des messages entrants.</li>
<li>La fonction <code>handle</code> est appelée par la boucle de réception des messages pour rechercher le handler correspondant au message reçu et l'activer.</li>
<li>Lors de son arrêt la fonction <code>finalize</code> est appelée avant sa destruction.</li>
</ul>
</li>
<li>Les fonctions <code>initialize</code> et <code>finalize</code> sont personnalisables par l'utilisateur.</li>
<li>Il est exécuté de manière mono-threadée.</li>
<li>Son état n'est modifiable qu'au travers des réactions des Handlers.</li>
<li>Son état n'est pas transmissible à un autre acteur.</li>
</ul>
<p>Si un mode d'exécution multi-threadé est nécessaire, par exemple pour effectuer un traitement coûteux en CPU, alors le Handler doit déléguer l'exécution de ce traitement à différents acteurs. Le traitement est donc exécuté en parallèle, et la charge associée est partagée entre ces acteurs.</p>
<p>L'acteur définit un end-point spécifique correspondant au socket d'écoute de l'acteur C/ZMQ sous-jacent, il utilise la notion de poller MAL pour écouter simultanément le end-point utilisateur et ce end-point interne. Ce end-point interne permet la réception de commandes envoyées à l'acteur, par la fontion <code>mal_actor_send_command</code>.</p>
<h2 id="api-actor-mal">API Actor MAL</h2>
<h3 id="constructeur">Constructeur</h3>
<p>Crée une instance d'acteur identifiée par une URI MAL. La création d'un acteur entraîne la création d'un end-point correspondant à l'URI MAL de cet acteur, et d'un routeur pour la gestion des handlers de cet acteur. L'état de ce routeur est l'état de l'acteur.</p>
<p>Un compteur de <code>Transaction Id</code> est géré.</p>
<p>Déclaration :</p>
<pre><code class="c">mal_actor_t *mal_actor_new(
  mal_ctx_t *mal_ctx,
  mal_uri_t *uri,
  void *state,
  mal_actor_initialize_fn *initialize,
  mal_actor_finalize_fn *finalize);
</code></pre>

<p>Paramètres :</p>
<ul>
<li><code>mal_ctx</code> : contexte MAL</li>
<li><code>uri</code> : URI MAL identifiant l'acteur MAL</li>
<li><code>state</code> : état de l'acteur; non typé pour permettre le polymorphisme</li>
<li><code>initialize</code> : fonction d'initialisation de l'acteur</li>
<li><code>finalize</code> : fonction de terminaison de l'acteur</li>
</ul>
<h3 id="fonction-virtuelle-dinitialisation-de-lacteur-mal">Fonction virtuelle d'initialisation de l'acteur MAL</h3>
<p>Déclaration :</p>
<pre><code class="c">typedef int mal_actor_initialize_fn(void *self, mal_ctx_t *mal_ctx,
  mal_actor_t *mal_actor);
</code></pre>

<p>Paramètres :</p>
<ul>
<li><code>self</code> : état de l'acteur</li>
<li><code>mal_ctx</code> : référence du contexte MAL</li>
<li><code>mal_actor</code> : référence de l'acteur</li>
</ul>
<p>Résultat :</p>
<p>Code d'erreur</p>
<h3 id="fonction-virtuelle-de-terminaison-de-lacteur-mal">Fonction virtuelle de terminaison de l'acteur MAL</h3>
<p>Déclaration :</p>
<pre><code class="c">typedef int mal_handler_finalize_fn(void *self, mal_ctx_t *mal_ctx,
  mal_actor_t *mal_actor);
</code></pre>

<p>Paramètres :</p>
<ul>
<li><code>self</code> : état de l'acteur</li>
<li><code>mal_ctx</code> : référence du contexte MAL</li>
<li><code>mal_actor</code> : référence de l'acteur</li>
</ul>
<p>Résultat :</p>
<p>Code d'erreur</p>
<h3 id="envoi-de-message-mal">Envoi de message MAL</h3>
<p>L'envoi de messages MAL se fait au travers du end-point intégré à l'acteur (voir interface définie en 7.4.2). L'interface de l'acteur définit une fonction permettant de retrouver le end-point correspondant :</p>
<pre><code class="c">mal_endpoint_t *mal_actor_get_mal_endpoint(mal_actor_t *self);
</code></pre>

<h3 id="enregistrement-des-handlers">Enregistrement des handlers</h3>
<p>L'enregistrement des handlers de l'acteur se fait au travers du routeur intégré à l'acteur ( voir interface définie en 7.6.3). L'interface de l'acteur définit une fonction permettant de retrouver le routeur correspondant :</p>
<pre><code class="c">mal_routing_t *mal_actor_get_router(mal_actor_t *self);
</code></pre>

<h3 id="envoi-de-commandes-a-lacteur-mal">Envoi de commandes à l'acteur MAL</h3>
<p>L'envoi de commandes à l'acteur MAL au travers de son end-point interne peut s'effectuer au travers de la fonction :</p>
<pre><code class="c">int mal_actor_send_command(mal_actor_t *to, char *cmd);
</code></pre>

<p>Cette fonction prend en paramètre l'acteur destinataire et la chaine de caractère contenant la commande. Par exemple :</p>
<pre><code class="c">mal_actor_send_command(actor, &quot;$TERM&quot;);
</code></pre>

<h3 id="destructeur">Destructeur</h3>
<p>Détruit l'acteur et son état.</p>
<pre><code class="c">void mal_actor_destroy(mal_actor_t **self_p);
</code></pre>

<h3 id="exemple-simple-dapplication-mal">Exemple simple d'application MAL</h3>
<p>Dans cet exemple nous reprenons le code de l'exemple du chapitre 4 mais en utilisant la librairie d'acteurs présentée dans ce chapitre. Une part importante du code est identique et nous ne détaillerons que les aspects spécifiquement liés à l'usage du framework d'acteurs MAL.</p>
<h3 id="composant-consumer">Composant consumer</h3>
<p>Lors de la création du composant concumer on crée un acteur MAL pour sa gestion :</p>
<pre><code class="c">send_app_myconsumer_t *consumer = send_app_myconsumer_new(
  provider_uri,
  authentication_id, qoslevel, priority, domain, network_zone, session,
  session_name, MALBINARY_FORMAT_CODE, encoder, decoder);
</code></pre>

<pre><code class="c">mal_uri_t *consumer_uri = mal_ctx_create_uri(mal_ctx, &quot;send_app/myconsumer&quot;);
mal_actor_t *consumer_actor = mal_actor_new(
  mal_ctx,
  consumer_uri, consumer,
  send_app_myconsumer_initialize, send_app_myconsumer_finalize);
</code></pre>

<p>Deux fonctions d'initialisation et de terminaison sont spécifiées à l'acteur, la fonction d'initialisation nous permet d'initier l'interaction SEND vers le provider. Ce code correspond au code la méthode run décrit en section 4.1.2.</p>
<h3 id="composant-provider">Composant Provider</h3>
<p>Lors de la création du composant provider on crée un acteur MAL pour sa gestion :</p>
<pre><code class="c">send_app_myprovider_t *provider =
  send_app_myprovider_new(MALBINARY_FORMAT_CODE, encoder, decoder);
</code></pre>

<pre><code class="c">mal_actor_t *provider_actor = mal_actor_new(
  mal_ctx,
  provider_uri, provider,
  send_app_myprovider_initialize, send_app_myprovider_finalize);
</code></pre>

<p>Deux fonctions d'initialisation et de terminaison sont spécifiées à l'acteur, la fonction d'initialisation permettra entre autre d'enregistrer les handlers du provider. La réception de message est maintenant implicitement gérée par l'acteur MAL :</p>
<ul>
<li>Lors de la réception d'un message MAL sur le end-point correspondant à l'URI du provider le handler enregistrés en automatiquement exécuté.</li>
<li>Dans le cas contraire le message est détruit.</li>
</ul>
<h3 id="lancement-de-lapplication">Lancement de l'application</h3>
<p>Les composants consumer et provider sont maintenant des acteurs MAL, ils ne nécessitent donc plus la création explicite d'un acteur ZMQ pour les exécuter :</p>
<pre><code class="c">send_app_create_provider(verbose, mal_ctx, provider_uri, encoder, decoder);
send_app_create_consumer(verbose, mal_ctx, provider_uri, encoder, decoder);
</code></pre>

<p>Le code de lancement de l'application est par ailleurs identique :</p>
<ul>
<li>création du contexte MAL,</li>
<li>création des encoder et decoder,</li>
<li>création du transport MALZMQ,</li>
<li>démarrage du contexte MAL.</li>
</ul></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script>var base_url = '..';</script>
        <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
        <script src="../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
